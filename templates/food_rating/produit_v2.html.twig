{% extends "base.html.twig" %}

{% block title %} {{ produit.product_name | capitalize }} {% endblock %}

{% block body %}
<script src="https://bootswatch.com/_vendor/jquery/dist/jquery.min.js"></script>
<div class="media pb-5">
	<img src="{{ produit.image_url ?? produit.image_front_url ?? produit.selected_images.front.display.fr ?? "/images/image_vide.png" }}" class="align-self-center mr-3" alt="" />
	<div class="media-body">
	
		{# Pour garder la catégorie "principale" #}
		{% if produit.categories is defined and produit.categories is not empty %}
			{% set cat = produit.categories | split(",") %}
		{% else %}
			{% set cat = ["Non renseignée"] %}
		{% endif %}
		
		<p> Nom : {{ produit.product_name | capitalize }} <br>
		{% if produit.brands_tags is defined %}
			Marque : {{ produit.brands ?? produit.brands_tags[0] }} <br>
		{% else %}
			Marque : Non renseignée <br>
		{% endif %}
		Catégorie : {{ cat[0] }}</p>
	</div>
</div>
<h3>Ingrédients</h3>
{% if produit.ingredients_text is defined %}
	<p> {{ produit.ingredients_text }} </p>
{% else %}
	<p>Non renseignés</p>
{% endif %}

<a type="button" target="_blank" class="btn btn-danger" href="{{ path("debug", {"id": produit.id ?? produit.code}) }}">Debug <i class="fas fa-exclamation-triangle"></i></a>

<div class="row pt-5">
	<div class="col">
		<h3>Note</h3>
		<div class="container w-60 float-left">
			<div class="row">
				<div class="col">
					<center style="padding-top: 22%;"><i class="fas fa-star fa-6x text-warning"></i>
					<p class="font-weight-bold mt-1" style="width:fit-content; font-size:x-large;">
					{% if moyenneNote != 0 %}
						Moyenne : {{ moyenneNote }}</p>
					{% else %}
						Pas de Note
					{% endif %}
					<p>(Nombre de votes : {{ nombreVote }})</p></center>
				</div>
				<div class="col">
					<span class="fa-stack my-1">
						<i class="fas fa-star fa-stack-2x text-warning"></i>
						<span class="fa-stack-1x font-weight-bold">1</span>
					</span>
					<div class="progress" style="background-color: #ebebf5">
						<div class="progress-bar bg-warning" style="width: {{ pourcentageEtoile1 }}%;"></div>
					</div>
					
					<span class="fa-stack my-1">
						<i class="fas fa-star fa-stack-2x text-warning"></i>
						<span class="fa-stack-1x font-weight-bold">2</span>
					</span>
					<div class="progress" style="background-color: #ebebf5">
						<div class="progress-bar bg-warning" style="width: {{ pourcentageEtoile2 }}%;"></div>
					</div>
					
					<span class="fa-stack my-1">
						<i class="fas fa-star fa-stack-2x text-warning"></i>
						<span class="fa-stack-1x font-weight-bold">3</span>
					</span>
					<div class="progress" style="background-color: #ebebf5">
						<div class="progress-bar bg-warning" style="width: {{ pourcentageEtoile3 }}%;"></div>
					</div>
					
					<span class="fa-stack my-1">
						<i class="fas fa-star fa-stack-2x text-warning"></i>
						<span class="fa-stack-1x font-weight-bold">4</span>
					</span>
					<div class="progress" style="background-color: #ebebf5">
						<div class="progress-bar bg-warning" style="width: {{ pourcentageEtoile4 }}%;"></div>
					</div>
					
					<span class="fa-stack my-1">
						<i class="fas fa-star fa-stack-2x text-warning"></i>
						<span class="fa-stack-1x font-weight-bold">5</span>
					</span>
					<div class="progress" style="background-color: #ebebf5">
						<div class="progress-bar bg-warning" style="width: {{ pourcentageEtoile5 }}%;"></div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div class="col">
		<h3>Produits similaires</h3>
		{% if similaires is not empty %}
		
		<div id="similaire" class="carousel slide" data-ride="carousel">
        
          <!-- Indicators -->
          <ul class="carousel-indicators">
          	{% for s in similaires | slice(0,10) %}
          		{% if loop.first %}
          			<li class="bg-primary" data-target="#similaire" data-slide-to="0" class="active"></li>
          		{% else %}
          			<li class="bg-primary" data-target="#similaire" data-slide-to="{{ loop.index0 }}"></li>
          		{% endif %}
          	{% endfor %}
          </ul>
          
          <div class="carousel-inner w-75 mx-auto" style="height: 310px;">
          {% for s in similaires | slice(0,10) %}
          
          	{% if loop.first %}
          		<div class="carousel-item active">
          	{% else %}
          		<div class="carousel-item">
          	{% endif %}
          	
              	<a href="{{ path("produit_v2", {"id" : s.id ?? s.code, "categorie": categorie}) }}">
              		<img class="d-block mx-auto img-thumbnail" style="height: 200px;" src="{{ s.image_url ?? s.image_front_url ?? s.selected_images.front.display.fr ?? "/images/image_vide.png" }}" alt="Image du produit : {{ s.product_name }}" />
              	</a>
              	<div class="carousel-caption d-none d-md-block" style="position: initial;">
                	<h5>{{ s.brands ?? s.brands_tags[0] ?? "Non renseigné" }}</h5>
                	<a href="{{ path("produit_v2", {"id" : s.id ?? s.code, "categorie": categorie}) }}">{{ s.product_name | capitalize }}</a>
                </div>
          	</div>
          
          {% endfor %}
          </div>
       
          <!-- Left and right controls -->
          <a class="carousel-control-prev" href="#similaire" role="button" data-slide="prev">
            <i class="fas fa-angle-left fa-3x text-primary"></i>
          </a>
          <a class="carousel-control-next" href="#similaire" role="button" data-slide="next">
            <i class="fas fa-angle-right fa-3x text-primary"></i>
          </a>
        
        </div>
	</div>
	{% else %}
		<p>Aucun produit similaire.</p>
	{% endif %}
	</div>
</div>

<div class="row">
<div class="col">
<h3 class="my-4">Noter</h3>
{% if app.user %}
	<script>
		$(document).ready(function(){

			function ExtractId(id) {
				var id=id.split('_');
				var id=id[1];
				return id;
			}
			
			$('.etoile').on('click', function(e){
				var id = ExtractId($(this).attr('id')); 
				var nbStars=$('.etoile').length; 
				var i;
				for (i = 1; i <= nbStars; i++) {
					if(i <= id) {
						$('#etoile_' + i).addClass('text-warning');
					}	
					else if(i > id){
						$('#etoile_' + i).removeClass('text-warning');
					}
					if(i==id) {
						$('#note').attr({value:i});
					}
				}
			});
		});
		{% if note is defined and app.user.id == note.utilisateur.id %}
			$(document).ready( function() {
				var nbStars=$('.etoile').length; 
				var i;
				for (i = 1; i <= {{ note.nbEtoiles }}; i++) {
					$('#etoile_' + i).addClass('text-warning');
				}
			});
		{% endif %}
	</script>
	{% if produit.categories is defined and produit.categories is not empty %}
		{% set cat = produit.categories | split(",") %}
	{% else %}
		{% set cat = ["Non renseignée"] %}
	{% endif %}

	<div class="row">
		{% if note is defined and app.user.id == note.utilisateur.id %}
			<form id="formulaire" action="{{ path("modifier_notation", {"id" : produit.id ?? produit.code, "categorie" : categorie }) }}" method="post">
				<div class="form-group">
					<label>Note : </label>
					<i class="fas fa-star fa-3x etoile" id="etoile_1" title="Pas du tout satisfait" style="cursor: pointer;"></i>
					<i class="fas fa-star fa-3x etoile" id="etoile_2" title="Pas satisfait" style="cursor: pointer;"></i>
					<i class="fas fa-star fa-3x etoile" id="etoile_3"title="Moyennement satisfait" style="cursor: pointer;"></i>
					<i class="fas fa-star fa-3x etoile" id="etoile_4"title="Satisfait" style="cursor: pointer;"></i>
					<i class="fas fa-star fa-3x etoile" id="etoile_5" title="Très satisfait" style="cursor: pointer;"></i><br>
					<input type="hidden" name="note" id="note" value="">
				</div>
				<div class="form-group">
					<label for="commentaire">Commentaire</label>
					{% if commentaire is defined %}
						<textarea class="form-control" name="commentaire" id="commentaire" rows="3">{{ commentaire.message }}</textarea>
					{% else %}
						<textarea class="form-control" name="commentaire" id="commentaire" rows="3"></textarea>
					{% endif %}
				</div>
				<div class="form-group">
					<input type="submit" class="btn btn-info" value="Modifier">
					<a type="button" href="{{ path("supprimer_notation", {"id" : produit.id ?? produit.code, "categorie" : categorie }) }}" class= "btn btn-danger">Supprimer</a>
				</div>
			</form>
			<!--<div id="loader"></div>-->
		{% else %}
			<form id="formulaire" action="{{ path("notation", {"id" : produit.id ?? produit.code, "categorie" : categorie }) }}" method="post">
				<div class="form-group">
					<label>Note : </label>
					<i class="fas fa-star fa-3x etoile" id="etoile_1" title="Pas du tout satisfait" style="cursor: pointer;"></i>
					<i class="fas fa-star fa-3x etoile" id="etoile_2" title="Pas satisfait" style="cursor: pointer;"></i>
					<i class="fas fa-star fa-3x etoile" id="etoile_3"title="Moyennement satisfait" style="cursor: pointer;"></i>
					<i class="fas fa-star fa-3x etoile" id="etoile_4"title="Satisfait" style="cursor: pointer;"></i>
					<i class="fas fa-star fa-3x etoile" id="etoile_5" title="Très satisfait" style="cursor: pointer;"></i>
					<input type="hidden" name="note" id="note" value="">
				</div>
				<div class="form-group">
					<label for="commentaire">Commentaire</label>
					<textarea class="form-control" name="commentaire" id="commentaire" rows="3"></textarea>
				</div>
				<div class="form-group">
					<input type="submit" class="btn btn-primary" value="Noter">
				</div>
			</form>
			<!--<div id="loader"></div>-->
		{% endif %}
		<!--<script>
            /* attach a submit handler to the form */
            $("#formulaire").submit(function(event) {

                /* stop form from submitting normally */
                event.preventDefault();

                /* get some values from elements on the page: */
                var $form = $(this),
                    url = $form.attr('action');

                /* Send the data using post */
                var posting = $.post(url);
            });
        </script>-->
		<!--<script>
			$(document).ready(function(){
				$(function(){
					$('#formulaire').submit(function(e){
					e.preventDefault();
					var formulaire = $(this);
					var post_url = formulaire.attr('action');
					var post_data = formulaire.serialize();
					$('#loader', formulaire).html('<img src="https://thumbs.gfycat.com/ElasticHalfAbyssiniancat-size_restricted.gif"/>');

					$.ajax({
						type: 'POST',
						url: post_url,
						data: post_data,
						success: function(msg) {
							formulaire.fadeOut(800, function(){
								formulaire.html(msg).fadeIn().delay(2000);
							});
						}
					});
					});
				});
			});
		</script>-->
	</div>
{% else %}
	<div class="row">
		<div class="col">
			<p>Pour noter un produit, merci de vous connecter !</p>
			<a type="button" class="btn btn-info" href="/connexion">Mon compte</a>
		</div>
	</div>
{% endif %}
	</div>
</div>

<hr class="my-5 border-primary" />
<h3 class="mb-3">Commentaires et Notes</h3>

{% if notesProduit is defined %}
	<div class="card-columns">
		{% for n in notesProduit %}
			<script>
				$(document).ready(function() {
					var nbStars=$('.etoile_affichage').length;
					var i;
					for (i = 1; i <= {{ n.nbEtoiles }}; i++) { $('#etoileAffichage{{ n.id }}_' + i).addClass('text-warning'); }
				});
			</script>
			
			<div class="card border-primary mb-3" style="max-width: 20rem;">
				<div class="card-header">{{ n.utilisateur.username }}</div>
				<div class="card-body">
					<p class="card-title">
						<i class="fas fa-star fa-2x etoile_affichage" id="etoileAffichage{{ n.id }}_1"></i>
						<i class="fas fa-star fa-2x etoile_affichage" id="etoileAffichage{{ n.id }}_2"></i>
						<i class="fas fa-star fa-2x etoile_affichage" id="etoileAffichage{{ n.id }}_3"></i>
						<i class="fas fa-star fa-2x etoile_affichage" id="etoileAffichage{{ n.id }}_4"></i>
						<i class="fas fa-star fa-2x etoile_affichage" id="etoileAffichage{{ n.id }}_5"></i>
					</p>
					
					{% for c in commentairesProduit %}
						{% if c.utilisateur.id == n.utilisateur.id %}
							<p class="card-text">{{ c.message }}</p>
						{% endif %}
					{% endfor %}
				</div>
				<div class="card-footer">{{ n.createdAt | date("d/m/Y - H:i") }}</div>
			</div>

		{% endfor %}
	</div>
	
{% else %}
	<p>Pas de commentaires pour ce produit.</p>
{% endif %}
<div class="flex-sm-wrap mt-5">

	<!-- Utilisation du sélecteur de pages de KNP -->
	{{ knp_pagination_render(notesProduit) }}
	
</div>

{% endblock %}